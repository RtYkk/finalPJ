---
applyTo: "android/**"
---

# Android module instructions

## Architecture & package layout
- Entry point lives in `app/src/main/java/jlu/kemiko/libman/MainActivity.kt`; keep it lightweight and delegate feature logic to subpackages.
- Maintain the following subpackages under `jlu.kemiko.libman`:
  - `data`: Room entities, DAO, database builders, and repositories implementing offline-first behavior and transactions.
  - `domain`: Optional use-case layer encapsulating business rules such as borrowing, returning, and search.
  - `ui`: Jetpack Compose screens, navigation graphs, and ViewModels, organized by feature (loans, inventory, scanning, etc.).
  - `scan`: CameraX preview, ML Kit barcode analyzer, and scanning state machine components.
  - `network`: Retrofit/OkHttp services, DTOs, and mappers for ISBN metadata fetches.
  - `common`: Shared validation helpers, time/formatting utilities, and result wrappers.
- Keep `libdocs/` assets out of runtime builds; treat them as design references only.
  - Favor straightforward implementations over elaborate architectures; aim for a minimal app that simply works.

## UI & state management
- Build UI exclusively with Jetpack Compose + Material 3; follow unidirectional data flow and hoist state to ViewModels or higher-level composables.
- Use Kotlin coroutines and Flow for asynchronous streams, exposing state via `StateFlow`/`SharedFlow` or Compose `State` adapters.
- Surface validation errors and loading states explicitly; avoid silent failures in UI.

## Data & transaction rules
- Persist all entities with Room; any stock mutation (borrow/return, inventory adjustments) must run inside a single Room transaction.
- Borrow flow: require `availableCount > 0`, decrement it, and insert `Loan(status = BORROWED)`.
- Return flow: update `Loan.status = RETURNED`, increment `availableCount`, and ensure the value stays within `[0, copyCount]`.
- Model migrations carefully—add migration specs when entity definitions change.

## Validation & identifiers
- Validate `StudentId` with the regex `^\d{8}$` at every entry point (UI, use cases, repositories).
- Only accept ISBN-13 values and prefer checksum verification before hitting the network or updating Room.

## Scanning & networking
- CameraX + ML Kit Barcode Scanning are mandatory; do not introduce alternate SDKs or fallback libraries.
- ISBN lookup sequence: read Room → if missing fetch via Retrofit/OkHttp → on success upsert locally → then render UI.
- Restrict network calls to ISBN metadata only; do not transmit student, loan, or inventory data.
- Configure Retrofit/OkHttp with short timeouts and a small disk cache; avoid unnecessary dependencies or API keys.

## Build & install
- From the `android/` directory run:
  - `./gradlew assembleDebug`
  - `./gradlew installDebug`
- If KSP or Room schema generation stalls, retry with `./gradlew clean assembleDebug`.

## Code review expectations
- Highlight any adjustments to scanning or networking in PR descriptions, detailing impacts on permissions, validation, and offline behavior.
- Keep reformatting focused on touched code; avoid large-scale file churn unrelated to the change at hand.
